<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Match - Puzzle Game</title>
    <meta name="description" content="Word Match - A challenging word puzzle game with cascading effects and strategic gameplay">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="style.css" as="style">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" as="style">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap">
    
    <!-- Favicon and app icons -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéØ</text></svg>">
    
    <!-- PWA meta tags -->
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Performance optimizations -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="format-detection" content="telephone=no">
</head>
<body class="game-page">
    <!-- Game Wrapper - matches demo structure -->
    <div class="game-wrapper">
        <!-- Game Container -->
        <div id="game-container">
        <!-- HTML UI Layer (HUD at top) -->
        <div class="ui-layer">
            <!-- HUD Elements -->
            <div class="score-panel">
                <div class="score-label">SCORE</div>
                <div class="score-value" id="score">0</div>
                
                <div class="target-info">
                    <div class="target-label" id="targetLabel">TARGET: 0</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar"></div>
                    </div>
                </div>
            </div>
            
            <div class="moves-panel">
                <div class="moves-value" id="movesRemaining">0</div>
                <div class="score-label">MOVES</div>
            </div>
        </div>
        
        <!-- Game Board Area with Grid Container (matches demo) -->
        <div class="grid-container">
            <div id="game-board-area" class="game-board-area">
                <!-- Phaser canvas goes here -->
            </div>
        </div>
        
        <!-- Current word display -->
        <div class="current-word" id="currentWord"></div>
        
        <!-- Emergency reset button (hidden by default) -->
        <div id="emergency-reset" class="emergency-reset" style="display: none;">
            <button id="reset-button" class="reset-button">Fix Game State</button>
        </div>
        
        <!-- Loading Screen -->
        <div id="loading-screen" class="loading-screen">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <h2>Word Match</h2>
                <p>Loading game...</p>
                <div class="loading-progress">
                    <div class="loading-bar"></div>
                </div>
            </div>
        </div>
        
        <!-- Error Screen (hidden by default) -->
        <div id="error-screen" class="error-screen" style="display: none;">
            <div class="error-content">
                <h2>‚ö†Ô∏è Game Error</h2>
                <p id="error-message">Something went wrong loading the game.</p>
                <button id="retry-button" class="game-button">Retry</button>
            </div>
        </div>
        </div> <!-- Close game-container -->
    </div> <!-- Close game-wrapper -->

    <!-- Victory Overlay -->
    <div class="overlay victory-overlay" id="victoryOverlay">
        <div class="overlay-content">
            <h1 class="victory-title">Level Complete!</h1>
            <div class="victory-stars">‚≠ê‚≠ê‚≠ê</div>
            
            <div class="score-summary">
                <div class="score-row">
                    <span>Score:</span>
                    <strong id="victoryScore">0</strong>
                </div>
                <div class="score-row">
                    <span>Target:</span>
                    <strong id="victoryTarget">0 ‚úì</strong>
                </div>
                <div class="score-row">
                    <span>Moves Used:</span>
                    <strong id="victoryMoves">0 / 0</strong>
                </div>
                <div class="score-row">
                    <span>Best Word:</span>
                    <strong id="victoryBestWord">--- (0 pts)</strong>
                </div>
            </div>
            
            <button class="overlay-button primary" id="nextLevelButton">Next Level</button>
        </div>
    </div>
    
    <!-- Defeat Overlay -->
    <div class="overlay defeat-overlay" id="defeatOverlay">
        <div class="overlay-content">
            <h1 class="defeat-title">Out of Moves!</h1>
            <div class="defeat-emoji">üò¢</div>
            
            <div class="lives-display">
                <div class="lives-label">Game Over</div>
                <div class="score-row">
                    <span>Your Score:</span>
                    <strong id="defeatScore" style="color: #e74c3c">0</strong>
                </div>
                <div class="score-row">
                    <span>Target Score:</span>
                    <strong id="defeatTarget" style="color: #e74c3c">0</strong>
                </div>
            </div>
            
            <button class="overlay-button danger" id="tryAgainButton">Try Again</button>
            <button class="overlay-button" id="mainMenuButton">Main Menu</button>
        </div>
    </div>

    <!-- Phaser 3 Framework -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    
    <!-- Game Systems (load in dependency order) -->
    <script src="src/utils/LevelLoader.js"></script>
    <script src="src/systems/WordValidator.js"></script>
    <script src="src/core/Tile.js"></script>
    <script src="src/core/Grid.js"></script>
    <script src="src/systems/EffectsQueue.js"></script>
    <script src="src/systems/ScoreSystem.js"></script>
    <script src="src/systems/InputSystem.js"></script>
    <script src="src/core/GameState.js"></script>
    <script src="src/core/GameScene.js"></script>
    
    <!-- Game Initialization -->
    <script>
        // Visual Style Constants (from style guide)
        const COLORS = {
            // Backgrounds
            bgDark: 0x2c3e50,
            bgPanel: 0x34495e,
            
            // Primary colors
            primary: 0x3498db,
            success: 0x2ecc71,
            danger: 0xe74c3c,
            warning: 0xf39c12,
            purple: 0x9b59b6,
            
            // UI colors
            cyan: 0x00d9ff,
            textLight: 0xecf0f1,
            textMuted: 0xbdc3c7,
            border: 0x34495e,
            
            // Tile backgrounds
            tileNormal: 0xecf0f1,
            tileBomb: 0xe74c3c,
            tileIce: 0x3498db,
            tileStone: 0x7f8c8d,
            tileMultiplier: 0xf39c12,
            tileHidden: 0x9b59b6
        };
        
        // Animation constants
        const ANIMATIONS = {
            hover: {
                scale: 1.05,
                duration: 100,
                ease: 'Back.easeOut'
            },
            selection: {
                scale: 1.15,
                duration: 200,
                ease: 'Back.easeOut'
            },
            explosion: {
                duration: 300,
                ease: 'Back.easeIn'
            },
            cascade: {
                delay: 50,
                duration: 150,
                ease: 'Sine.easeInOut'
            }
        };
        
        // Make constants globally available
        window.COLORS = COLORS;
        window.ANIMATIONS = ANIMATIONS;
        
        // HTML UI Management System
        window.UIManager = {
            // UI Elements
            elements: {
                score: null,
                targetLabel: null,
                progressBar: null,
                movesRemaining: null,
                currentWord: null,
                victoryOverlay: null,
                defeatOverlay: null,
                gameContainer: null
            },
            
            // Initialize UI elements
            init() {
                this.elements.score = document.getElementById('score');
                this.elements.targetLabel = document.getElementById('targetLabel');
                this.elements.progressBar = document.getElementById('progressBar');
                this.elements.movesRemaining = document.getElementById('movesRemaining');
                this.elements.currentWord = document.getElementById('currentWord');
                this.elements.victoryOverlay = document.getElementById('victoryOverlay');
                this.elements.defeatOverlay = document.getElementById('defeatOverlay');
                this.elements.gameContainer = document.getElementById('game-container');
                
                // Setup overlay button handlers
                this.setupOverlayHandlers();
                
                console.log('UIManager initialized');
            },
            
            // Setup overlay button event handlers
            setupOverlayHandlers() {
                // Victory overlay buttons
                document.getElementById('nextLevelButton').addEventListener('click', () => {
                    this.closeOverlay('victory');
                    if (window.game && window.game.scene.isActive('GameScene')) {
                        window.game.scene.getScene('GameScene').handleNextLevel();
                    }
                });
                
                // Defeat overlay buttons
                document.getElementById('tryAgainButton').addEventListener('click', () => {
                    this.closeOverlay('defeat');
                    if (window.game && window.game.scene.isActive('GameScene')) {
                        window.game.scene.getScene('GameScene').restartLevel();
                    }
                });
                
                document.getElementById('mainMenuButton').addEventListener('click', () => {
                    this.closeOverlay('defeat');
                    // For now, just restart the current level
                    if (window.game && window.game.scene.isActive('GameScene')) {
                        window.game.scene.getScene('GameScene').restartLevel();
                    }
                });
            },
            
            // Update score display
            updateScore(current, target) {
                if (this.elements.score) {
                    this.elements.score.textContent = current.toLocaleString();
                }
                if (this.elements.targetLabel) {
                    this.elements.targetLabel.textContent = `TARGET: ${target.toLocaleString()}`;
                }
                this.updateProgress(current, target);
            },
            
            // Update progress bar
            updateProgress(current, target) {
                if (this.elements.progressBar) {
                    const progress = Math.min((current / target) * 100, 100);
                    this.elements.progressBar.style.width = progress + '%';
                    
                    // Add completion effect
                    if (progress >= 100) {
                        this.elements.progressBar.style.background = 'linear-gradient(90deg, #2ecc71, #27ae60)';
                        this.elements.progressBar.style.boxShadow = '0 0 15px rgba(46, 204, 113, 0.8)';
                    }
                }
            },
            
            // Update moves display
            updateMoves(remaining, max) {
                if (this.elements.movesRemaining) {
                    this.elements.movesRemaining.textContent = remaining;
                    
                    // Update color based on remaining moves
                    this.elements.movesRemaining.className = 'moves-value';
                    if (remaining <= 2) {
                        this.elements.movesRemaining.classList.add('low');
                    } else if (remaining <= 5) {
                        this.elements.movesRemaining.classList.add('medium');
                    }
                }
            },
            
            // Show current word being traced
            showCurrentWord(word) {
                if (this.elements.currentWord) {
                    if (word && word.length > 0) {
                        this.elements.currentWord.textContent = word;
                        this.elements.currentWord.classList.add('visible');
                    } else {
                        this.elements.currentWord.classList.remove('visible');
                    }
                }
            },
            
            // Show victory overlay
            showVictory(data) {
                if (this.elements.victoryOverlay && this.elements.gameContainer) {
                    // Update victory data
                    document.getElementById('victoryScore').textContent = data.score.toLocaleString();
                    document.getElementById('victoryTarget').textContent = `${data.target.toLocaleString()} ‚úì`;
                    document.getElementById('victoryMoves').textContent = `${data.movesUsed} / ${data.maxMoves}`;
                    document.getElementById('victoryBestWord').textContent = `${data.bestWord} (${data.bestScore} pts)`;
                    
                    // Show overlay with blur effect
                    this.elements.gameContainer.classList.add('blurred');
                    this.elements.victoryOverlay.classList.add('active');
                    
                    // Animate stars
                    this.animateVictoryStars();
                    
                    // Create confetti
                    this.createConfetti();
                }
            },
            
            // Show defeat overlay
            showDefeat(data) {
                if (this.elements.defeatOverlay && this.elements.gameContainer) {
                    // Update defeat data
                    document.getElementById('defeatScore').textContent = data.score.toLocaleString();
                    document.getElementById('defeatTarget').textContent = data.target.toLocaleString();
                    
                    // Show overlay with blur effect
                    this.elements.gameContainer.classList.add('blurred');
                    this.elements.defeatOverlay.classList.add('active');
                }
            },
            
            // Close overlay
            closeOverlay(type) {
                if (this.elements.gameContainer) {
                    this.elements.gameContainer.classList.remove('blurred');
                }
                
                if (type === 'victory' && this.elements.victoryOverlay) {
                    this.elements.victoryOverlay.classList.remove('active');
                } else if (type === 'defeat' && this.elements.defeatOverlay) {
                    this.elements.defeatOverlay.classList.remove('active');
                }
            },
            
            // Animate victory stars
            animateVictoryStars() {
                const stars = document.querySelector('.victory-stars');
                if (stars) {
                    stars.innerHTML = '';
                    ['‚≠ê', '‚≠ê', '‚≠ê'].forEach((star, index) => {
                        setTimeout(() => {
                            const span = document.createElement('span');
                            span.textContent = star;
                            span.style.display = 'inline-block';
                            span.style.animation = 'star-appear 0.5s ease-out';
                            stars.appendChild(span);
                        }, index * 200);
                    });
                }
            },
            
            // Create confetti effect
            createConfetti() {
                const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6'];
                for (let i = 0; i < 20; i++) {
                    setTimeout(() => {
                        const confetti = document.createElement('div');
                        confetti.className = 'confetti';
                        confetti.style.left = Math.random() * 100 + '%';
                        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                        confetti.style.animationDelay = Math.random() * 0.5 + 's';
                        confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
                        document.body.appendChild(confetti);
                        
                        setTimeout(() => confetti.remove(), 4000);
                    }, i * 100);
                }
            }
        };
        
        // Game configuration - matched to demo styling
        const gameConfig = {
            type: Phaser.AUTO,
            width: 450,
            height: 500,
            backgroundColor: 0x34495e, // Match demo's dark blue background
            parent: 'game-board-area',
            scale: {
                mode: Phaser.Scale.FIT, // Change to FIT mode to scale properly on mobile
                autoCenter: Phaser.Scale.CENTER_HORIZONTALLY, // Only center horizontally, not vertically
                width: 450,
                height: 500
            },
            render: {
                antialias: true,
                pixelArt: false
            },
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 },
                    debug: false
                }
            },
            // Input configuration
            input: {
                mouse: true,
                touch: true,
                keyboard: true,
                gamepad: false
            },
            // Focus handling - manually handle focus/blur
            disableContextMenu: true,
            // Set to false so we can handle it manually in our visibility handlers
            pauseOnBlur: false,
            scene: GameScene
        };
        
        // Game initialization with error handling
        let game;
        let loadingScreen;
        let errorScreen;
        
        function initializeGame() {
            try {
                // Get loading elements
                loadingScreen = document.getElementById('loading-screen');
                errorScreen = document.getElementById('error-screen');
                
                // Initialize UI Manager
                window.UIManager.init();
                
                // Show loading screen
                showLoadingScreen();
                
                // Debug: Log container dimensions
                const gameContainer = document.getElementById('game-container');
                const gameBoardArea = document.getElementById('game-board-area');
                console.log('Game container dimensions:', gameContainer.offsetWidth, 'x', gameContainer.offsetHeight);
                console.log('Game board area dimensions:', gameBoardArea.offsetWidth, 'x', gameBoardArea.offsetHeight);
                
                // Initialize Phaser game
                game = new Phaser.Game(gameConfig);
                
                // Make game instance globally available for emergency reinitialization
                window.game = game;
                
                // Handle game ready
                game.events.once('ready', () => {
                    console.log('Game initialized successfully');
                    hideLoadingScreen();
                });
                
                // Add emergency game reinitialization function to window
                window.reinitializeGame = function() {
                    try {
                        if (game) {
                            // Check if scene is paused and resume it
                            if (game.scene.isPaused('GameScene')) {
                                game.scene.resume('GameScene');
                            }
                            
                            // Get the game scene - works whether it was active or just resumed
                            const gameScene = game.scene.getScene('GameScene');
                            
                            if (!gameScene) {
                                game.scene.start('GameScene');
                                return "Game scene restarted. Please try again.";
                            }
                            
                            // ROOT CAUSE FIX: Check if game is stuck in 'animating' state
                            if (gameScene.gameState === 'animating') {
                                // Force game state to 'playing' which will enable input
                                gameScene.setGameState('playing');
                                
                                // Reset EffectsQueue if it's stuck
                                if (gameScene.effectsQueue) {
                                    gameScene.effectsQueue.isProcessing = false;
                                    gameScene.effectsQueue.currentEffect = null;
                                    gameScene.effectsQueue.clearQueue();
                                    
                                    // Manually emit queue-empty event to ensure proper state transition
                                    gameScene.effectsQueue.events.emit('queue-empty');
                                }
                            }
                            
                            // Reset our custom input system
                            if (gameScene.inputSystem) {
                                gameScene.inputSystem.reset();
                                gameScene.inputSystem.setEnabled(true);
                                gameScene.inputSystem.reRegisterInputEvents();
                            }
                            
                            // Reset Phaser's input system
                            if (gameScene.input) {
                                gameScene.input.enabled = true;
                                
                                if (gameScene.input.manager) {
                                    gameScene.input.manager.enabled = true;
                                    
                                    // Reset all pointers
                                    gameScene.input.manager.pointers.forEach(pointer => {
                                        pointer.reset();
                                    });
                                }
                            }
                            return "Game state and input system fixed. You should be able to play again without losing your progress.";
                        } else {
                            return "Game scene not active, cannot fix game state.";
                        }
                    } catch (error) {
                        console.error('Error during game state fix:', error);
                        return "Error during game state fix: " + error.message;
                    }
                };
                
                // Handle game errors
                game.events.on('error', (error) => {
                    console.error('Game error:', error);
                    showErrorScreen('Game initialization failed: ' + error.message);
                });
                
                // Setup retry functionality
                document.getElementById('retry-button').addEventListener('click', () => {
                    location.reload();
                });
                
                // Set up emergency reset button
                setupEmergencyResetButton();
                
            } catch (error) {
                console.error('Failed to initialize game:', error);
                showErrorScreen('Failed to start game: ' + error.message);
            }
        }
        
        // Set up emergency reset button functionality
        function setupEmergencyResetButton() {
            const resetButton = document.getElementById('reset-button');
            const resetContainer = document.getElementById('emergency-reset');
            
            if (resetButton && resetContainer) {
                // Show reset button when focus returns to the page
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible') {
                        // Show the reset button after a short delay
                        setTimeout(() => {
                            resetContainer.style.display = 'block';
                        }, 500);
                    }
                });
                
                // Also show on window focus
                window.addEventListener('focus', () => {
                    // Show the reset button after a short delay
                    setTimeout(() => {
                        resetContainer.style.display = 'block';
                    }, 500);
                });
                
                // Set up click handler
                resetButton.addEventListener('click', () => {
                    // Call the reinitializeGame function
                    window.reinitializeGame();
                    
                    // Hide the reset button
                    resetContainer.style.display = 'none';
                });
            }
            
            // Add keyboard shortcut (Ctrl+Shift+R) for emergency reset
            document.addEventListener('keydown', (e) => {
                // Check for Ctrl+Shift+R
                if (e.ctrlKey && e.shiftKey && e.key === 'R') {
                    e.preventDefault(); // Prevent browser refresh
                    
                    // Call the reinitializeGame function
                    window.reinitializeGame();
                    
                    // Hide the reset button if it's visible
                    if (resetContainer) {
                        resetContainer.style.display = 'none';
                    }
                }
            });
        }
        
        function showLoadingScreen() {
            if (loadingScreen) {
                loadingScreen.style.display = 'flex';
                
                // Animate loading bar
                const loadingBar = loadingScreen.querySelector('.loading-bar');
                if (loadingBar) {
                    loadingBar.style.width = '0%';
                    setTimeout(() => {
                        loadingBar.style.width = '100%';
                    }, 100);
                }
            }
        }
        
        function hideLoadingScreen() {
            if (loadingScreen) {
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 300);
            }
        }
        
        function showErrorScreen(message) {
            hideLoadingScreen();
            if (errorScreen) {
                document.getElementById('error-message').textContent = message;
                errorScreen.style.display = 'flex';
            }
        }
        
        // Initialize game when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeGame);
        } else {
            initializeGame();
        }
        
        // Handle page visibility changes (pause/resume)
        document.addEventListener('visibilitychange', () => {
            if (game) {
                if (document.hidden) {
                    // Pause the game scene if it's active
                    if (game.scene.isActive('GameScene')) {
                        game.scene.pause('GameScene');
                    }
                } else {
                    // Resume the game scene if it's paused
                    if (game.scene.isPaused('GameScene')) {
                        game.scene.resume('GameScene');
                        
                        // Force a reset of the input system after resuming
                        setTimeout(() => {
                            const gameScene = game.scene.getScene('GameScene');
                            if (gameScene && typeof gameScene.recreateInputSystem === 'function') {
                                gameScene.recreateInputSystem();
                            }
                        }, 100);
                    }
                }
            }
        });
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (game) {
                game.scale.refresh();
            }
        });
        
        // Prevent context menu on right click (for better mobile experience)
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });
        
        // Prevent zoom on double tap (iOS Safari)
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>