<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Special Tiles Test - Word Match</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #2c3e50;
            color: white;
        }
        
        #game-container {
            display: flex;
            gap: 20px;
        }
        
        #game-canvas {
            border: 2px solid #34495e;
            background-color: #34495e;
        }
        
        #controls {
            min-width: 300px;
            background-color: #34495e;
            padding: 20px;
            border-radius: 8px;
        }
        
        .control-group {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #2c3e50;
            border-radius: 5px;
        }
        
        .control-group h3 {
            margin-top: 0;
            color: #3498db;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
        }
        
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .test-pass {
            background-color: #27ae60;
            color: white;
        }
        
        .test-fail {
            background-color: #e74c3c;
            color: white;
        }
        
        .test-info {
            background-color: #f39c12;
            color: white;
        }
        
        #test-log {
            max-height: 400px;
            overflow-y: auto;
            background-color: #1a252f;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .tile-legend {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border: 1px solid #34495e;
        }
    </style>
</head>
<body>
    <h1>Special Tiles System Test</h1>
    <p>Test all special tile behaviors: Bomb, Ice, Stone, Multiplier, and Hidden tiles</p>
    
    <div id="game-container">
        <div id="game-canvas"></div>
        
        <div id="controls">
            <div class="control-group">
                <h3>Tile Legend</h3>
                <div class="tile-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ecf0f1;"></div>
                        <span>Normal</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e74c3c;"></div>
                        <span>Bomb</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #3498db;"></div>
                        <span>Ice (2 hits)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #95a5a6;"></div>
                        <span>Stone (4 hits)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f39c12;"></div>
                        <span>Multiplier (2x)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #7f8c8d;"></div>
                        <span>Hidden</span>
                    </div>
                </div>
            </div>
            
            <div class="control-group">
                <h3>Special Tile Tests</h3>
                <button onclick="testBombTiles()">Test Bomb Explosions</button>
                <button onclick="testIceTiles()">Test Ice Tiles (2 hits)</button>
                <button onclick="testStoneTiles()">Test Stone Tiles (4 hits)</button>
                <button onclick="testMultiplierTiles()">Test Multiplier Scoring</button>
                <button onclick="testHiddenTiles()">Test Hidden Reveals</button>
                <button onclick="testSpawnRates()">Test Spawn Rates</button>
            </div>
            
            <div class="control-group">
                <h3>Grid Controls</h3>
                <button onclick="createTestGrid()">Create Test Grid</button>
                <button onclick="resetGrid()">Reset Grid</button>
                <button onclick="clearTests()">Clear Test Log</button>
            </div>
            
            <div class="control-group">
                <h3>Test Results</h3>
                <div id="test-log"></div>
            </div>
        </div>
    </div>

    <!-- Load game scripts -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    <script src="../src/core/Tile.js?v=3"></script>
    <script src="../src/core/Grid.js?v=3"></script>
    <script src="../src/systems/ScoreSystem.js?v=3"></script>
    <script src="../src/systems/WordValidator.js?v=3"></script>
    <script src="../src/systems/EffectsQueue.js?v=3"></script>
    <script src="../src/utils/LevelLoader.js?v=3"></script>

    <script>
        let game;
        let scene;
        let grid;
        let scoreSystem;
        let testResults = [];

        // Test configuration
        const testConfig = {
            gridSize: { width: 6, height: 6 },
            targetScore: 1000,
            moves: 20,
            tileDistribution: "scrabble_uk",
            ripple: {
                spread: 0.5,
                power: 1,
                threshold: 3
            },
            specialTiles: {
                bomb: 0.1,
                multiplier: 0.1,
                ice: 0.1,
                stone: 0.1,
                hidden: 0.1
            }
        };

        function logTest(message, type = 'info') {
            const log = document.getElementById('test-log');
            const entry = document.createElement('div');
            entry.className = `test-result test-${type}`;
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
            
            testResults.push({ message, type, timestamp: Date.now() });
        }

        function clearTests() {
            document.getElementById('test-log').innerHTML = '';
            testResults = [];
        }

        class TestScene extends Phaser.Scene {
            constructor() {
                super({ key: 'TestScene' });
            }

            preload() {
                // Load configuration
                this.load.json('settings', '../config/settings.json');
                this.load.json('levels', '../config/levels.json');
            }

            create() {
                scene = this;
                
                // Load settings and level config
                const settings = this.cache.json.get('settings');
                const levels = this.cache.json.get('levels');
                
                this.registry.set('settings', settings);
                this.registry.set('levelConfig', { ...testConfig, tileDistributionData: levels.tileDistributions.scrabble_uk });
                
                // Initialize systems
                scoreSystem = new ScoreSystem(this);
                
                logTest('Test scene initialized', 'pass');
                createTestGrid();
            }
        }

        function initializeGame() {
            const config = {
                type: Phaser.AUTO,
                width: 500,
                height: 500,
                parent: 'game-canvas',
                backgroundColor: '#2c3e50',
                scene: TestScene
            };

            game = new Phaser.Game(config);
        }

        function createTestGrid() {
            if (!scene) {
                logTest('Scene not ready', 'fail');
                return;
            }

            if (grid) {
                grid.destroy();
            }

            try {
                // Test special tile generation directly
                logTest('Testing special tile generation...', 'info');
                
                grid = new Grid(scene, testConfig);
                logTest(`Created ${testConfig.gridSize.width}x${testConfig.gridSize.height} test grid`, 'pass');
                
                // Log tile type distribution
                const stats = grid.getStats();
                logTest(`Tile distribution: ${JSON.stringify(stats.tilesByType)}`, 'info');
                
                // Test the rollForSpecialTile method directly
                logTest('Testing rollForSpecialTile method...', 'info');
                for (let i = 0; i < 10; i++) {
                    const specialType = grid.rollForSpecialTile();
                    logTest(`Roll ${i + 1}: ${specialType}`, 'info');
                }
                
            } catch (error) {
                logTest(`Failed to create grid: ${error.message}`, 'fail');
                console.error('Grid creation error:', error);
            }
        }

        function resetGrid() {
            if (grid) {
                grid.resetSurgeCounts();
                logTest('Grid reset - all surge counts cleared', 'info');
            }
        }

        function testBombTiles() {
            if (!grid) {
                logTest('No grid available for testing', 'fail');
                return;
            }

            logTest('Testing bomb tile explosions...', 'info');
            
            // Find bomb tiles
            const bombTiles = grid.getAllTiles().filter(tile => tile.type === TILE_TYPES.BOMB);
            
            if (bombTiles.length === 0) {
                logTest('No bomb tiles found in grid', 'fail');
                return;
            }

            bombTiles.forEach((bombTile, index) => {
                const neighbors = grid.getNeighbors(bombTile.gridX, bombTile.gridY);
                const affectedTiles = grid.handleSpecialTileInteraction(bombTile);
                
                logTest(`Bomb ${index + 1} at (${bombTile.gridX},${bombTile.gridY}) affects ${affectedTiles.length}/${neighbors.length} neighbors`, 
                       affectedTiles.length === neighbors.length ? 'pass' : 'fail');
            });
        }

        function testIceTiles() {
            if (!grid) {
                logTest('No grid available for testing', 'fail');
                return;
            }

            logTest('Testing ice tile health system...', 'info');
            
            const iceTiles = grid.getAllTiles().filter(tile => tile.type === TILE_TYPES.ICE);
            
            if (iceTiles.length === 0) {
                logTest('No ice tiles found in grid', 'fail');
                return;
            }

            iceTiles.forEach((iceTile, index) => {
                const initialHealth = iceTile.health;
                logTest(`Ice tile ${index + 1} initial health: ${initialHealth}`, initialHealth === 2 ? 'pass' : 'fail');
                
                // Test first hit
                const destroyed1 = iceTile.takeDamage();
                logTest(`Ice tile ${index + 1} after 1 hit: health=${iceTile.health}, destroyed=${destroyed1}`, 
                       iceTile.health === 1 && !destroyed1 ? 'pass' : 'fail');
                
                // Test second hit
                const destroyed2 = iceTile.takeDamage();
                logTest(`Ice tile ${index + 1} after 2 hits: health=${iceTile.health}, destroyed=${destroyed2}`, 
                       iceTile.health === 0 && destroyed2 ? 'pass' : 'fail');
            });
        }

        function testStoneTiles() {
            if (!grid) {
                logTest('No grid available for testing', 'fail');
                return;
            }

            logTest('Testing stone tile health system...', 'info');
            
            const stoneTiles = grid.getAllTiles().filter(tile => tile.type === TILE_TYPES.STONE);
            
            if (stoneTiles.length === 0) {
                logTest('No stone tiles found in grid', 'fail');
                return;
            }

            stoneTiles.forEach((stoneTile, index) => {
                const initialHealth = stoneTile.health;
                logTest(`Stone tile ${index + 1} initial health: ${initialHealth}`, initialHealth === 4 ? 'pass' : 'fail');
                
                // Test multiple hits
                for (let hit = 1; hit <= 4; hit++) {
                    const destroyed = stoneTile.takeDamage();
                    const expectedHealth = 4 - hit;
                    const shouldBeDestroyed = hit === 4;
                    
                    logTest(`Stone tile ${index + 1} after ${hit} hits: health=${stoneTile.health}, destroyed=${destroyed}`, 
                           stoneTile.health === expectedHealth && destroyed === shouldBeDestroyed ? 'pass' : 'fail');
                    
                    if (destroyed) break;
                }
            });
        }

        function testMultiplierTiles() {
            if (!grid || !scoreSystem) {
                logTest('Grid or ScoreSystem not available for testing', 'fail');
                return;
            }

            logTest('Testing multiplier tile scoring...', 'info');
            
            // Create test tiles for scoring
            const normalTile = new Tile(scene, 0, 0, 'A', 1, TILE_TYPES.NORMAL);
            const multiplierTile = new Tile(scene, 1, 0, 'B', 3, TILE_TYPES.MULTIPLIER);
            
            // Test normal word (no multiplier)
            const normalWord = [normalTile];
            const normalScore = scoreSystem.calculateWordScore(normalWord);
            logTest(`Normal word 'A' score: ${normalScore}`, normalScore === 1 ? 'pass' : 'fail');
            
            // Test word with multiplier
            const multiplierWord = [normalTile, multiplierTile];
            const multiplierScore = scoreSystem.calculateWordScore(multiplierWord);
            const expectedScore = Math.floor((1 + 3) * 2.0); // (A + B) * multiplier
            logTest(`Multiplier word 'AB' score: ${multiplierScore} (expected: ${expectedScore})`, 
                   multiplierScore === expectedScore ? 'pass' : 'fail');
            
            // Test score breakdown
            const breakdown = scoreSystem.getScoreBreakdown(multiplierWord);
            logTest(`Multiplier breakdown - hasMultiplier: ${breakdown.hasMultiplier}, bonus: ${breakdown.multiplierBonus}`, 
                   breakdown.hasMultiplier && breakdown.multiplierBonus > 0 ? 'pass' : 'fail');
        }

        function testHiddenTiles() {
            if (!grid) {
                logTest('No grid available for testing', 'fail');
                return;
            }

            logTest('Testing hidden tile reveal system...', 'info');
            
            const hiddenTiles = grid.getAllTiles().filter(tile => tile.type === TILE_TYPES.HIDDEN);
            
            if (hiddenTiles.length === 0) {
                logTest('No hidden tiles found in grid', 'fail');
                return;
            }

            hiddenTiles.forEach((hiddenTile, index) => {
                const initialRevealed = hiddenTile.isRevealed;
                logTest(`Hidden tile ${index + 1} initially revealed: ${initialRevealed}`, !initialRevealed ? 'pass' : 'fail');
                
                // Apply surges to trigger reveal
                for (let surge = 1; surge <= 3; surge++) {
                    hiddenTile.applySurge();
                    const shouldBeRevealed = surge >= 3;
                    
                    logTest(`Hidden tile ${index + 1} after ${surge} surges: revealed=${hiddenTile.isRevealed}`, 
                           hiddenTile.isRevealed === shouldBeRevealed ? 'pass' : 'fail');
                    
                    if (hiddenTile.isRevealed) break;
                }
            });
        }

        function testSpawnRates() {
            if (!grid) {
                logTest('No grid available for testing', 'fail');
                return;
            }

            logTest('Testing special tile spawn rates...', 'info');
            
            const stats = grid.getStats();
            const totalTiles = stats.totalTiles;
            
            Object.entries(testConfig.specialTiles).forEach(([type, expectedRate]) => {
                const actualCount = stats.tilesByType[type.toUpperCase()] || 0;
                const actualRate = actualCount / totalTiles;
                const tolerance = 0.05; // 5% tolerance
                
                const withinTolerance = Math.abs(actualRate - expectedRate) <= tolerance;
                logTest(`${type} tiles: ${actualCount}/${totalTiles} (${(actualRate * 100).toFixed(1)}%, expected ${(expectedRate * 100).toFixed(1)}%)`, 
                       withinTolerance ? 'pass' : 'info');
            });
        }

        // Initialize the game when page loads
        window.addEventListener('load', () => {
            initializeGame();
        });
    </script>
</body>
</html>